<dialog
  id="addFurnitureModal"
  class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50"
>
  <div class="modal-content">
    <h2>
      {{
        furnitureService.furnitureToEdit != null &&
        furnitureService.furnitureToEdit != undefined
          ? "Modifier"
          : "Ajouter"
      }}
      un meuble
    </h2>

    <form [formGroup]="furnitureForm" (submit)="onSubmit()">
      <div class="mb-3 flex items-center gap-4">
        <label for="name" class="form-label w-20">Nom <app-required /></label>
        <input
          id="name"
          pInputText
          class="flex-1"
          formControlName="name"
          type="text"
          placeholder="Entrez le nom du meuble (minimum 3 caractères)"
        />
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="building" class="form-label w-20"
          >Bâtiment <app-required
        /></label>
        @if (buildingService.status === "pending") {
          <p>Chargement...</p>
        } @else {
          <p-select
            inputId="building"
            styleClass="flex-1"
            formControlName="buildingId"
            [options]="buildingService.buildings"
            optionLabel="name"
            optionValue="id"
            (onChange)="
              this.buildingService.onBuildingChange(this.furnitureForm)
            "
            placeholder="Choisissez un bâtiment"
          />
        }
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="storey" class="form-label w-20"
          >Étage <app-required
        /></label>
        @if (storeyService.status === "pending") {
          <p>Chargement...</p>
        } @else {
          <p-select
            inputId="storey"
            styleClass="flex-1"
            formControlName="storeyId"
            [options]="storeyService.storeys"
            optionLabel="name"
            optionValue="id"
            (onChange)="this.storeyService.onStoreyChange(this.furnitureForm)"
            placeholder="Choisissez un étage"
          />
        }
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="room" class="form-label w-20">Pièce <app-required /></label>
        @if (storeyService.status === "pending") {
          <p>Chargement...</p>
        } @else {
          <p-select
            inputId="room"
            styleClass="flex-1"
            formControlName="roomId"
            [options]="roomService.rooms"
            optionLabel="name"
            optionValue="id"
            placeholder="Choisissez une pièce"
          />
        }
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="type" class="form-label w-20">Type <app-required /></label>
        @if (typeService.status === "pending") {
          <p>Chargement...</p>
        } @else {
          <p-select
            inputId="type"
            styleClass="flex-1"
            formControlName="typeId"
            [options]="typeService.types"
            optionLabel="name"
            optionValue="id"
            placeholder="Choisissez un type"
          />
        }
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="state" class="form-label w-20">État <app-required /></label>
        @if (stateService.status === "pending") {
          <p>Chargement...</p>
        } @else {
          <p-select
            inputId="state"
            styleClass="flex-1"
            formControlName="stateId"
            [options]="stateService.states"
            optionLabel="name"
            optionValue="id"
            placeholder="Choisissez un état"
          />
        }
      </div>

      <div class="mb-3 flex items-center gap-4">
        <label for="model" class="form-label w-20"
          >Modèle <app-required
        /></label>
        <input
          id="model"
          pInputText
          class="flex-1"
          formControlName="model"
          type="text"
          placeholder="Entrez le modèle du meuble (url vers le fichier .glb)"
        />
      </div>

      <!-- Section des actions sur le meuble -->
      @if (
        canModifyPosition ||
        canAssign ||
        canManageStorage ||
        canViewHistory ||
        canViewFunctionalState
      ) {
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 class="text-lg font-semibold mb-3 text-gray-800">
            Actions sur le meuble
          </h3>
          <div class="flex flex-wrap gap-3 justify-start">
            @if (canModifyPosition) {
              <p-button
                label="Scan/GPS"
                styleClass="p-button-help"
                (onClick)="onScanGPS()"
                type="button"
              ></p-button>
            }
            @if (canAssign) {
              <p-button
                label="Affecter/Désaffecter"
                styleClass="p-button-danger"
                (onClick)="onAssign()"
                type="button"
              ></p-button>
            }
            @if (canManageStorage) {
              <p-button
                label="Stocker"
                styleClass="p-button-lime"
                (onClick)="onStore()"
                type="button"
              ></p-button>
              <p-button
                label="Céder"
                styleClass="p-button-gray"
                (onClick)="onDispose()"
                type="button"
              ></p-button>
            }
            @if (canViewHistory && furniture != null) {
              <p-button
                label="Voir historique"
                styleClass="p-button-info"
                (onClick)="onViewHistory()"
                type="button"
              ></p-button>
            }
            @if (canViewFunctionalState) {
              <p-button
                label="Voir état fonctionnel"
                styleClass="p-button-teal"
                (onClick)="onViewFunctionalState()"
                type="button"
              ></p-button>
            }
          </div>
        </div>
      }

      <div class="modal-actions flex justify-end gap-3 mt-6">
        <p-button
          label="Annuler"
          styleClass="p-button-secondary"
          (onClick)="furnitureService.closeModal()"
          type="button"
        ></p-button>
        @if (furnitureService.furnitureToEdit) {
          <p-button
            label="Supprimer"
            styleClass="p-button-danger"
            (onClick)="onDelete()"
            type="button"
          ></p-button>
        }

        <p-button
          [label]="furnitureService.furnitureToEdit ? 'Sauvegarder' : 'Ajouter'"
          styleClass="p-button-success"
          type="submit"
        ></p-button>
      </div>
    </form>

    <ul>
      @for (
        log of furnitureService.furnitureToEdit?.historyLogs;
        track log.id
      ) {
        <li>
          <strong>{{ log.modifiedAt | date: "short" }} :</strong> ({{
            log.column === "State"
              ? "État"
              : log.column === "Type"
                ? "Type"
                : log.column === "Name"
                  ? "Nom"
                  : "Emplacement"
          }}) Ancienne valeur: {{ log.newValue }} | Nouvelle valeur:
          {{ log.oldValue }}
        </li>
      }
    </ul>
  </div>
</dialog>
